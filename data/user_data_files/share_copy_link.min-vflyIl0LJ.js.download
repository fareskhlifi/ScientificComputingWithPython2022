define(["require","exports","tslib","typescript/component_libraries/spectrum-sharing/src/utils/index","typescript/component_libraries/spectrum-sharing/src/utils/sharing_constants","metaserver/static/js/clean/analytics","metaserver/static/js/sharing/api/client","metaserver/static/js/sharing/ui_notifications_util","metaserver/static/js/sharing/views/share_modal_evolution/utils/logging","metaserver/static/js/clean/ui/snackbar","metaserver/static/js/core/browser_detection","metaserver/static/js/clean/web_user_action_events","metaserver/static/js/clean/clipboard_v3"],(function(e,r,t,a,i,s,n,o,c,l,u,d,_){"use strict";var p,f;Object.defineProperty(r,"__esModule",{value:!0}),r.copyLink=r.isBrowserCopyEnabled=r.getApiClient=void 0,(function(e){e.SHARED_LINK_ALREADY_EXISTS="shared_link_already_exists",e.ACCESS_DENIED="access_denied",e.PATH="path",e.NOT_FOUND="not_found",e.EMAIL_NOT_VERIFIED="email_not_verified",e.SETTINGS_ERROR="settings_error",e.NOT_AUTHORIZED="not_authorized",e.UNDEFINED_ERROR="undefined_error"})(p||(p={})),(function(e){e.CLIPBOARD_API="clipboard_api",e.EXEC_COMMAND="exec_command"})(f||(f={}));const g=e=>{const{metadata:r}=e;(0,_.copyToClipboard)(r.url,()=>{h(e,f.EXEC_COMMAND)},()=>{E(e)})},h=(e,r)=>{const t=e.metadata?e.metadata.url:"";(0,o.showCopyLinkSuccessSnackbar)(t,O(e.metadata)),S({file:e.file,user:e.user,event:a.TiburonEventName.CopySharedLink,metadata:e.metadata,extras:{created_new_link:e.isNewlyCreated,copy_method:r},surfaceOrigin:e.userActionSource})},E=e=>{(e=>{if(navigator.clipboard){const r=e.metadata.url;navigator.clipboard.writeText(r).then((function(){h(e,f.CLIPBOARD_API)}),(function(){m(e)}))}else m(e)})(e)},m=e=>{const r=e.metadata?e.metadata.url:"";(0,o.showCopyLinkErrorSnackbar)(r,O(e.metadata)),S({file:e.file,user:e.user,event:a.TiburonEventName.CopySharedLinkFailure,metadata:e.metadata,extras:{error:"failed_copy_to_clipboard"},surfaceOrigin:e.userActionSource})},C=e=>e.file_id||e.fq_path,O=e=>{const r=e?e.link_permissions.link_access_level:void 0;let t="viewer";return r&&(t=r.hasOwnProperty(".tag")?r[".tag"]:r),t},S=({file:e,user:r,event:t,metadata:a,extras:n={},surfaceOrigin:o})=>{const l=o===d.ActionSourceValue.OVERFLOW_MENU?i.SHARE_ACTION_ORIGIN_TYPE.BROWSE_FILE_ROW_OVERFLOW_MENU:i.SHARE_ACTION_ORIGIN_TYPE.BROWSE_FILE_ROW_BUTTON,_=(0,u.get_browser_info)();s.ShareTibEventLogger.log(r.id,t,l,Object.assign(Object.assign(Object.assign({},(0,c.buildExtraFromLinkMetadata)(a)),{file_id:e.file_id,fq_path:e.fq_path,browser:_.browser,browser_version:_.version}),n))},w=({file:e,user:r,surfaceOrigin:t,exceptionType:i,httpCode:s})=>{S({file:e,user:r,event:a.TiburonEventName.FailCreateSharedLinkWithSettings,extras:{error_message:i,http_status_code:s,is_alpha:!1},surfaceOrigin:t}),S({file:e,user:r,event:a.TiburonEventName.CopySharedLinkFailure,extras:{error:i},surfaceOrigin:t})};r.getApiClient=e=>new n.FileShareApiClient({userId:e.id});function b(e,t,i){t(!1,C(e.file)),(0,r.isBrowserCopyEnabled)()?g(e):(0,o.showCopyLinkCTASnackbar)(e.metadata.url,()=>{(e=>{l.Snackbar.close("sharing-notification"),g(e)})(e)},"sharing-notification",O(e.metadata));const s=e.isNewlyCreated?200:i&&i.raw&&i.raw.status;S({file:e.file,user:e.user,event:a.TiburonEventName.SucceedCreateSharedLinkWithSettings,metadata:e.metadata,extras:{created_new_link:e.isNewlyCreated,http_status_code:s,response_status:"success",is_alpha:!1},surfaceOrigin:e.userActionSource})}r.isBrowserCopyEnabled=()=>{const e=document.createElement("input");e.value="sharing is caring",document.body.appendChild(e),e.select();const r=document.queryCommandEnabled("copy");return document.body.removeChild(e),r},r.copyLink=function(e,a,i,s,n){n=n||{access:{".tag":"max"}},(0,o.showCopyLinkProgressSupportedBrowserSnackbar)();const c=C(a);i(!0,c),(0,r.getApiClient)(e).createSharedLinkNonAlpha({fileIdOrPath:c,settings:n}).then(r=>{b({file:a,user:e,metadata:r,isNewlyCreated:!0,userActionSource:s},i)}).catch(n=>t.__awaiter(this,void 0,void 0,(function*(){var t;if(n.error[".tag"]===p.SHARED_LINK_ALREADY_EXISTS){let o=null===(t=n.error.shared_link_already_exists)||void 0===t?void 0:t.metadata;if(!o){o=(yield(0,r.getApiClient)(e).sharedLinkInfo({fileIdOrPath:a.fq_path}))[0]}b({file:a,user:e,metadata:o,isNewlyCreated:!1,userActionSource:s},i,n)}else if(n.error[".tag"]===p.ACCESS_DENIED)i(!1,c),(0,o.showCopyLinkNoPermissionSnackbar)(),w({file:a,user:e,surfaceOrigin:s,exceptionType:n.error[".tag"],httpCode:n.raw&&n.raw.status});else if(n.error[".tag"]===p.SETTINGS_ERROR&&n.error.settings_error[".tag"]===p.NOT_AUTHORIZED)i(!1,c),(0,o.showCopyLinkNoPermissionSnackbar)(),w({file:a,user:e,surfaceOrigin:s,exceptionType:n.error.settings_error[".tag"],httpCode:n.raw&&n.raw.status});else if(n.error[".tag"]===p.PATH&&n.error.path[".tag"]===p.NOT_FOUND)i(!1,c),(0,o.showCopyLinkNotFoundSnackbar)(),w({file:a,user:e,surfaceOrigin:s,exceptionType:n.error.path[".tag"],httpCode:n.raw&&n.raw.status});else if(n.error[".tag"]===p.EMAIL_NOT_VERIFIED)i(!1,c),(0,o.showCopyLinkEmailNotVerifiedSnackbar)(),w({file:a,user:e,surfaceOrigin:s,exceptionType:n.error[".tag"],httpCode:n.raw&&n.raw.status});else{i(!1,c);const r=n.error[".tag"]?n.error[".tag"]:p.UNDEFINED_ERROR;(0,o.showCopyLinkCatchallSnackbar)(),w({file:a,user:e,surfaceOrigin:s,exceptionType:r,httpCode:n.raw&&n.raw.status})}})))}}));
//# sourceMappingURL=share_copy_link.min.js-vfl2iZTjY.map