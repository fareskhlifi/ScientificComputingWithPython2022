define(["require","exports","tslib","react","dropbox-capture-sdk","react-redux","metaserver/static/js/browse/data/selectors","metaserver/static/js/user_metadata/api","metaserver/static/js/browse/uri_helper","metaserver/static/js/core/i18n","metaserver/static/js/browse/action_logger","metaserver/static/js/clean/ui/snackbar","metaserver/static/js/clean/viewer","metaserver/static/js/clean/web_user_action_events","metaserver/static/js/sharing/async_share_modal_util","typescript/component_libraries/spectrum-sharing/src/utils/sharing_constants","metaserver/static/js/filepath/filepath","metaserver/static/js/growth/ui/rich_snackbar_actions/action_handlers","metaserver/static/js/capture/recorder","metaserver/static/js/core/browser"],(function(e,t,a,r,s,i,o,n,c,l,d,u,_,m,E,p,f,C,R,v){"use strict";var g;Object.defineProperty(t,"__esModule",{value:!0}),t.PreviewRecorder=t.AsyncRecorder=t.canUseRecorder=void 0,r=a.__importStar(r),R=a.__importDefault(R),v=a.__importStar(v);const h=l.intl.formatMessage({id:"8r1z6a",defaultMessage:"Share"}),A=l.intl.formatMessage({id:"CgXNiX",defaultMessage:"Copy link"}),S=l.intl.formatMessage({id:"Qu2AUQ",defaultMessage:"View recording"});t.canUseRecorder="function"==typeof(null===(g=navigator.mediaDevices)||void 0===g?void 0:g.getDisplayMedia);t.AsyncRecorder=e=>{const{source:t,user:a,uploadPath:s}=e;return r.default.createElement(R.default,{onClose:()=>{e.setRecorder(!1)},onUpload:t=>{t.capture_link&&(e.setCapture(t),e.onRecordingComplete())},showRecorder:e.showRecorder,source:t,uploadPath:s,useCamera:!0,captureLink:!0,user:a})};t.PreviewRecorder=e=>{const[R,g]=(0,r.useState)(!1),[I,P]=(0,r.useState)(!0),[T,b]=(0,r.useState)(!1),{isInsideMyTeamFolderTree:U,isInsideSharedFolder:w,isInsideTeamFolderTree:D,currentNSPath:k,currentNSID:W}=(0,i.useSelector)(o.context),{captureUpload:M,captureUploadRef:O,source:N,user:j}=e;(0,r.useEffect)(()=>{a.__awaiter(void 0,void 0,void 0,(function*(){const e=(yield(0,n.getUserMetadata)(["CAPTURE_FILES_INTEGRATION_HAS_CREATED_CAPTURES_WITH_WEB_RECORDER"],j.id)).CAPTURE_FILES_INTEGRATION_HAS_CREATED_CAPTURES_WITH_WEB_RECORDER;P(!e)}))},[j]),(0,r.useEffect)(()=>{!R&&M&&g(!0)},[M]),(0,r.useEffect)(()=>{R&&(I?(b(!0),P(!1),(0,d.logWebUserAction)({event_name:m.WebUserActionLogEvent.CAPTURE_SDK_FILES_DOWNLOAD_MODAL_SHOWN,user_id:j.id})):K(),g(!1))},[R,I,j]);const L=({filePath:e})=>(u.Snackbar.close("capture-sdk-files-success"),(0,E.asyncShowShareModal)(j.id,{fqPath:e,isFolder:!1},{origin:p.SHARE_ACTION_ORIGIN_TYPE.PREVIEW_PAGE})),{storagePath:y,uploadPath:F}=(0,r.useMemo)(()=>{const e=!U&&!w&&!D,t=(0,c.getUserRoot)(_.Viewer.get_viewer(),j);return{storagePath:!e||null==k?`${t}/Capture`:window.location.pathname,uploadPath:e&&null!=k?k:"/Capture"}},[U,w,D,k,j]),H=e=>{G(),(0,C.handleCopyLinkClick)(e)},x=({filePath:e})=>{const t=e.slice(e.lastIndexOf("/")+1),a=`${window.location.origin}${y}?preview=${encodeURIComponent(t)}`;(0,d.logWebUserAction)({event_name:m.WebUserActionLogEvent.CAPTURE_SDK_FILES_VIEW_RECORDING_CLICKED,user_id:j.id}),v.open_tab(a)},G=()=>{u.Snackbar.close("capture-sdk-files-success")},K=()=>{var e,t;if(!R)return;const a=null!==(t=null===(e=O.current)||void 0===e?void 0:e.name)&&void 0!==t?t:"";u.Snackbar.show(r.default.createElement(u.Snackbar,{id:"capture-sdk-files-success",richSnackbarProps:{actions:[{name:"share",text:h,onClick:L},{name:"copy_link",text:A,onClick:H},{name:"view_recording",text:S,onClick:x}],clickHandlerArgs:{userId:j.id,filePath:(0,f.joinPathWithFileName)({fqPath:F,fileName:a}),ns_id:W},onCloseClick:G},onTimeout:G,timeoutDelayMsForCompleteVariant:5e3,title:l.intl.formatMessage({id:"iZbi1W",defaultMessage:"Created {filename}"},{filename:a}),variant:"complete"}))};return r.default.createElement(r.default.Fragment,null,r.default.createElement(t.AsyncRecorder,Object.assign({},e,{uploadPath:F})),r.default.createElement(s.DownloadCaptureModal,{onClose:()=>{(0,n.setUserMetadata)({CAPTURE_FILES_INTEGRATION_HAS_CREATED_CAPTURES_WITH_WEB_RECORDER:!0},j.id),b(!1),K()},onConfirm:()=>{(0,d.logWebUserAction)({event_name:m.WebUserActionLogEvent.CAPTURE_SDK_FILES_DOWNLOAD_CTA_CLICKED,user_id:j.id})},open:T,source:N}))}}));
//# sourceMappingURL=previews_recorder.min.js-vfluPIKKp.map