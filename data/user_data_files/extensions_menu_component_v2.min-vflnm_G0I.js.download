define(["require","exports","tslib","classnames","react","react-redux","lodash","dig-components/buttons","dig-components/icons","dig-components/icons/src","dig-components/menu","dig-components/icons/src","spectrum/tooltip/index","metaserver/static/js/file_store/utils","metaserver/static/js/integrations/data/selectors","metaserver/static/js/extensions/apis","metaserver/static/js/extensions/shared_file_popover_content_component","metaserver/static/js/app_actions/telemetry_client","metaserver/static/js/components/ui/css","metaserver/static/js/extensions/data/action_creators","metaserver/static/js/extensions/data/helpers","metaserver/static/js/extensions/data/selectors","metaserver/static/js/extensions/data/types","metaserver/static/js/extensions/extensions_popover_content_component_v2","metaserver/static/js/extensions/extensions_utils","metaserver/static/js/extensions/file","metaserver/static/js/extensions/tooltips","metaserver/static/js/file_viewer/open_button/types","metaserver/static/js/file_viewer/unity/with_unity","metaserver/static/js/core/i18n"],(function(e,t,n,s,o,i,r,a,l,p,c,d,u,g,f,h,m,v,y,b,x,I,E,w,_,C,S,T,O,P){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExtensionsPopoverContent=t.ExtensionsMenuV2=t.ExtensionsMenuV2NoUnity=t.ExtensionsMenuV2Component=void 0,s=n.__importDefault(s),o=n.__importDefault(o);class A extends o.default.Component{constructor(e){super(e),this.handleButtonClick=e=>{e.preventDefault(),e.stopPropagation()},this.handleMenuClick=e=>{e.preventDefault(),e.stopPropagation()},this.handleHover=()=>{this.currentSession&&this.currentSession.event("trigger_hover")},this.setBigTooltip=e=>n.__awaiter(this,void 0,void 0,(function*(){const{file:t,appActions:n,featureFlags:s}=this.props,o=(0,C.getFileExt)(t)||"",i=n.length>0;if(i){const t=yield(0,h.getTooltipHistory)(e,["open_with_edu"]),n=(0,S.allowedTooltips)(i,o,s).find(e=>void 0!==t[e]&&!t[e]);this.setState({bigTooltipName:n})}})),this.markBigTooltipViewed=()=>{let e=!1;const t=[];this.state.bigTooltipName&&(t.push((0,h.markTooltipViewed)(this.props.user.id,this.state.bigTooltipName)),e=!0),e&&(Promise.all(t).then(()=>{this.props.showBigTooltip&&this.setBigTooltip(this.props.user.id)}),this.setState({bigTooltipName:void 0}))},this.handleSelectAction=(e,t)=>{t.preventDefault(),e.handler(),this.props.onExtensionClick&&this.props.onExtensionClick(e.actionName||e.userAction),this.logToPreviews(e,!1),t.stopPropagation()},this.logToPreviews=(e,t)=>{if(this.props.telemetryContext&&"previews"===this.props.telemetryContext.surface&&e.userAction){const t=e.actionName?{app_action_name:e.actionName}:{};(0,g.isBrowseFile)(this.props.file)&&this.props.file.read_only&&(t.readOnly=!0)}},this.renderTrigger=e=>{const{triggerType:t}=this.props,n=Object.assign({onMouseDown:this.markBigTooltipViewed,onMouseEnter:this.handleHover},e),i="app-action-open-with-menu__trigger app-action-open-with-menu__trigger-button",p=P.intl.formatMessage({id:"z5t3Bh",defaultMessage:"Open"}),c=(0,r.uniqueId)("app-action-open-with-menu-");return t===E.TriggerType.OpacityButton?o.default.createElement(a.Button,Object.assign({id:c,variant:"opacity",withDropdownIcon:!0},n,{"aria-labelledby":(0,s.default)(c,this.props.arialabelledby)}),p):t===E.TriggerType.CollapsedButton?o.default.createElement(u.Tooltip,{positionOffset:8,positioning:"left",tooltipContent:P.intl.formatMessage({id:"KEegJt",defaultMessage:"Open With"})},o.default.createElement(a.IconButton,Object.assign({id:c,variant:"transparent",className:i,"aria-label":p,"aria-labelledby":(0,s.default)(c,this.props.arialabelledby)},n),o.default.createElement(l.UIIcon,{src:d.OpenLine}))):o.default.createElement(a.Button,Object.assign({id:c,className:i,variant:t&&t!==E.TriggerType.SecondaryButton?"primary":"opacity","aria-label":p,"aria-labelledby":(0,s.default)(c,this.props.arialabelledby)},n),o.default.createElement("div",{className:"app-actions-open-with-menu__trigger-content app-actions-open-with-menu__trigger-content--with-text"},o.default.createElement("div",{className:"app-action-open-with-menu__trigger-button-text"},`${p} â–¾`)))},this.renderMenu=()=>o.default.createElement(c.Menu.Wrapper,{className:"app-actions__unportaled-menu",onSelection:this.handleSelectAction,onToggle:this.onPopoverToggle,isPortaled:!0},({getContentProps:e,getTriggerProps:n})=>o.default.createElement(o.default.Fragment,null,this.renderTrigger(n({onClick:this.handleButtonClick})),o.default.createElement(c.Menu.Content,Object.assign({},e({}),{onClick:this.handleMenuClick,className:"app-actions-open-with-menu",placement:"bottom-end"}),o.default.createElement(t.ExtensionsPopoverContent,{user:this.props.user,file:this.props.file,arialabelledby:this.props.arialabelledby,unityInfo:this.props.unityInfo,extraOptions:this.props.extraOptions,sharingServiceInfo:this.props.sharingServiceInfo,refreshSharingServiceInfo:this.props.refreshSharingServiceInfo,onPresentInZoom:this.props.onPresentInZoom,currentSession:this.currentSession,telemetryContext:this.props.telemetryContext})))),this.onPopoverToggle=({isOpen:e})=>{e&&this.props.onDropdownOpen?this.props.onDropdownOpen():!e&&this.props.onDropdownClose&&this.props.onDropdownClose(),this.currentSession&&this.currentSession.event(e?"open_popover":"close_popover")},this.onDownloadClick=e=>t=>{t.preventDefault(),t.stopPropagation(),e.handler(),this.logToPreviews(e,!0)},this.state={},this.telemetryClient=(0,v.createTelemetryClient)({component:"menu_v2"})}componentDidMount(){this.props.showBigTooltip&&this.setBigTooltip(this.props.user.id)}render(){const{file:e,appActions:t,featureFlags:n,telemetryContext:i,triggerType:c,showAsButtonIfDownloadOnly:d,unityInfo:u,extraOptions:f,user:h,sharingServiceInfo:m,refreshSharingServiceInfo:y,onPresentInZoom:b,landingPagesEnabled:I,cloudDocsInfo:w}=this.props;if(!e.file_id)return null;i?this.currentSession=this.telemetryClient.session({surface:i.surface,ext:(0,v.getPiiSafeExtension)((0,C.getFileExt)(e)||""),feature_flags:n}):delete this.currentSession;const S=(0,_.getOpenOptionsForFile)({file:e,unityInfo:u,extraOptions:f,user:h,sharingServiceInfo:m,refreshSharingServiceInfo:y,onPresentInZoom:b,landingPagesEnabled:I,isCloudEditorDisabled:!0,cloudDocsInfo:w,surface:null==i?void 0:i.surface}),O=c===E.TriggerType.CollapsedButton;let A=S.length>0,D=!1;if(A&&1===S.length&&(D=S[0].type===T.OpenButtonAction.DOWNLOAD,A=!D),!A&&(0===t.length||(0,g.isSharedFile)(e)&&0===(0,x.partitionActions)(t).cloudEditors.length)){if(d&&D){const e={className:(0,s.default)("app-actions-download-button",{"app-actions-download-button--collapsed":O}),onClick:this.onDownloadClick(S[0])},t=(0,r.uniqueId)("app-actions-download-button-");return O?o.default.createElement(a.IconButton,Object.assign({id:t,variant:"transparent","aria-labelledby":(0,s.default)(t,this.props.arialabelledby)},e),o.default.createElement(l.UIIcon,{name:"download-file",src:p.DownloadLine,"aria-label":P.intl.formatMessage({id:"pHnJw0",defaultMessage:"Download"})})):o.default.createElement(a.Button,Object.assign({id:t,variant:"opacity","aria-labelledby":(0,s.default)(t,this.props.arialabelledby)},e),P.intl.formatMessage({id:"pHnJw0",defaultMessage:"Download"}))}return null}return this.renderMenu()}}t.ExtensionsMenuV2Component=A,A.displayName="ExtensionsMenuV2Component";const D={updateLinkState:(e,t)=>(0,b.updateLinkState)({actionId:e,linkState:t}),refreshSharingServiceInfo:b.refreshSharingServiceInfoAdapter},B=(0,i.connect)((e,t)=>({appActions:(0,I.getOpenActionsForFile)(e,t.file),bylines:(0,I.getBylines)(e),categoryInfos:(0,I.getCategoryInfos)(e),featureFlags:(0,I.getFeatureFlags)(e),cloudDocsInfo:(0,I.getCloudDocInfo)(e),landingPagesEnabled:(0,f.isConnectServiceLandingPagesEnabled)(e)}),D),j=B(A);t.ExtensionsMenuV2NoUnity=(0,y.requireCssWithComponent)(j,["/static/metaserver/static/css/app_actions/index-vflQ27cHM.css","/static/metaserver/static/css/dig-components/index.web-vflD7DS1H.css"]);const F=B(e=>(0,g.isBrowseFile)(e.file)?o.default.createElement(O.WithUnity,{file:e.file,user:e.user,render:t=>o.default.createElement(A,Object.assign({},e,{unityInfo:t}))}):o.default.createElement(A,Object.assign({},e)));t.ExtensionsMenuV2=(0,y.requireCssWithComponent)(F,["/static/metaserver/static/css/app_actions/index-vflQ27cHM.css","/static/metaserver/static/css/dig-components/index.web-vflD7DS1H.css"]);const M=e=>{const{file:t,user:n,telemetryContext:s,appActions:i,bylines:r,categoryInfos:a,featureFlags:l,updateLinkState:p,unityInfo:c,extraOptions:d,sharingServiceInfo:u,refreshSharingServiceInfo:f,onPresentInZoom:h,landingPagesEnabled:y,cloudDocsInfo:b,isInActionBar:I,previewActionHandler:E,openDesktopActionHandler:S,goToFolderActionHandler:T,replayActionHandler:O,openInNewTabActionHandler:P,onExtensionClick:A}=e,D=(0,_.getCategoryIdToInfos)(a),B=(0,_.getOpenOptionsForFile)({file:t,unityInfo:c,extraOptions:d,user:n,sharingServiceInfo:u,refreshSharingServiceInfo:f,onPresentInZoom:h,landingPagesEnabled:y,isCloudEditorDisabled:!0,cloudDocsInfo:b,surface:null==s?void 0:s.surface,isInActionBar:I,previewActionHandler:E,openDesktopActionHandler:S,goToFolderActionHandler:T,replayActionHandler:O,openInNewTabActionHandler:P}),j=s&&(e.currentSession||(0,v.createTelemetryClient)({component:"menu_v2"}).session({surface:s.surface,ext:(0,v.getPiiSafeExtension)((0,C.getFileExt)(t)||""),feature_flags:l}));if((0,g.isBrowseFile)(t)&&(i.length>0||B.length>0))return o.default.createElement(w.ExtensionsPopoverV2WithUnity,{file:t,user:n,openOptions:B,appActions:i,bylines:r,categoryIdToInfos:D,featureFlags:l,updateLinkState:p,telemetryContext:s,currentSession:j,isInActionBar:I,onExtensionClick:A});if((0,g.isSharedFile)(t)){const{cloudEditors:e}=(0,x.partitionActions)(i);return o.default.createElement(m.SharedFilePopoverContent,{openOptions:B,cloudEditorAppActions:e,file:t,user:n,currentSession:j,isInActionBar:I})}return null};M.displayName="ExtensionsPopoverContentController",t.ExtensionsPopoverContent=B(M)}));
//# sourceMappingURL=extensions_menu_component_v2.min.js-vfl_ivPJI.map